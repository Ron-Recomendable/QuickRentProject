@using System.Security.Claims
<style>
    body {
        background: #F4F4F4;
    }
    .button {
        max-width: 200px;
        max-height: 26px;
        border-radius: 3px;
    }
    .button {
        max-width: 36px;
        max-height: 26px;
        border-radius: 3px;
    }

    /* Centered page title (match Items) */
    .items-title { text-align: center; padding: 1rem 0; letter-spacing: 0.1em; }

    #vue-modern {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 20px;
    }

    #vue-modern thead { background-color: #f5f5f5; font-weight: bold; }
    #vue-modern thead th {
        text-align: center;
        vertical-align: middle;
    }
    #vue-modern th, #vue-modern td { padding: 10px 14px; border-bottom: 1px solid #ddd; font-size: 14px; }
    #vue-modern tbody td {
        text-align: center;
        vertical-align: middle;
    }
    #vue-modern td:last-child { display: flex; justify-content: center; gap: 2px; }

    #vue-modern .vue-btn {
      border: none;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #vue-modern .vue-btn.edit:hover { background-color: #e0a800; }
    #vue-modern .vue-btn.details:hover { background-color: #138496; }
    #vue-modern .vue-btn.delete:hover { background-color: #c82333; }

    #vue-modern tbody tr:nth-child(odd) { background-color: #F6F6F3; }
    #vue-modern tbody tr:nth-child(even) { background-color: #ffffff; }
    #vue-modern tbody tr:hover { background-color: #f1f1f1; }

    /* Sort dropdown styles */
    .sort-dropdown { position: relative; }
    .sort-dropdown .sort-btn {
        background: #0078D4;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        transition: background 0.2s ease, color 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .sort-dropdown .sort-btn:hover { background: #0a74c1; }
    .sort-icon { display: inline-flex; width: 16px; height: 16px; }
    .caret { display: inline-flex; width: 10px; height: 10px; }

    .dropdown-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        z-index: 1000;
        display: none;
        min-width: 16rem;
        padding: 0.5rem 0;
        margin: 0;
        font-size: 0.95rem;
        color: #212529;
        list-style: none;
        background-color: #fff;
        border: 1px solid rgba(0,0,0,.12);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,.12);
    }
    .dropdown-menu.show { display: block; }
    .dropdown-header { font-weight: 700; font-size: 12px; color: #6c757d; padding: .35rem 1rem; margin-top: .25rem; }
    .dropdown-item { display: block; width: 100%; padding: .45rem 1rem; color: #212529; text-decoration: none; cursor: pointer; }
    .dropdown-item:hover { background-color: #f8f9fa; }
    .dropdown-item.active, .dropdown-item.active:focus, .dropdown-item.active:hover {
        background-color: #E6F4FF; color: #0a58ca; font-weight: 600;
    }

    .stars {
        color: #f5b301;
        font-size: 1rem;
        letter-spacing: 1px;
    }

    /* Create button (match Bookings/Items style) */
    .create {
        background: #4caf50;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        transition: background 0.2s ease, color 0.2s ease;
        text-align: center;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .create:hover { background: #388e3c; color: #fff; }

    /* Actions column and separators */
    .actions { display: inline-flex; align-items: center; gap: 6px; }
    #vue-modern .vue-btn { height: 26px; }

    /* Vertical separators for all columns */
    #vue-modern thead th:not(:first-child) { border-left: 1.5px solid #e3e3e3; }
    #vue-modern tbody td:not(:first-child) { border-left: 1.5px solid #e9e9e9; }

    /* Actions-specific vertical rule */
    #vue-modern thead th.actions-header { border-left: 1.5px solid #e3e3e3; }
    #vue-modern tbody td.actions-cell { border-left: 1.5px solid #e3e3e3; }
</style>
@model PaginatedList<QuickRentProject.Models.Review>

@{
    ViewData["Title"] = "Index";
    var currentSort = (string)(ViewData["CurrentSort"] ?? "rating_asc");
    var currentFilter = (string)(ViewData["CurrentFilter"] ?? "");
    var currentUserId = User.Identity.IsAuthenticated ? User.FindFirstValue(ClaimTypes.NameIdentifier) : null;
}

<h1 class="items-title">Reviews</h1>

<form asp-action="Index" method="get" style="margin-bottom:2rem; display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; border:1px solid #ccc; border-radius:6px; padding:0.5rem 1rem; background:#fff; max-width:420px; width:100%; height:44px;">
        <input type="text" name="SearchString" value="@currentFilter" placeholder="Find a review" style="border:none; outline:none; flex:1; font-size:1rem; color:#444; height:100%;" />
        <button type="submit" style="background:none; border:none; cursor:pointer; height:100%; display:flex; align-items:center;" title="Search">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#222" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="8" stroke="#222" stroke-width="2" fill="none"/>
                <line x1="17" y1="17" x2="22" y2="22" stroke="#222" stroke-width="2"/>
            </svg>
        </button>
        <a asp-action="Index" style="margin-left:1rem; display:flex; align-items:center; text-decoration:none; height:100%;" title="Clear search">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M15 19l-7-7 7-7" stroke="#222" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </a>
    </div>

    <div style="display:flex; align-items:center; gap:0.75rem;">
        @if (User.IsInRole("Admin") || User.IsInRole("Renter")) {
            <a asp-action="Create" class="create" title="Create review">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="2" fill="#4caf50"/>
                    <line x1="12" y1="8" x2="12" y2="16" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="12" x2="16" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Write a Review
            </a>
        }
        <div class="sort-dropdown dropdown">
            <button id="reviewsSortDropdownBtn" class="sort-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-controls="reviewsSortDropdownMenu">
                <span class="sort-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" focusable="false" aria-hidden="true">
                        <path d="M10 6h10v2H10V6zM4 5h4v4H4V5zm6 6h10v2H10v-2zM4 11h4v4H4v-4zm6 6h10v2H10v-2zM4 17h4v4H4v-4z"></path>
                    </svg>
                </span>
                Sort
                <span class="caret" aria-hidden="true">
                    <svg viewBox="0 0 16 16" width="10" height="10" fill="currentColor" focusable="false" aria-hidden="true">
                        <path d="M3.2 5.5L8 10.3l4.8-4.8.7.7L8 11.7 2.5 6.2l.7-.7z"/>
                    </svg>
                </span>
            </button>
            <ul id="reviewsSortDropdownMenu" class="dropdown-menu" role="menu" aria-labelledby="reviewsSortDropdownBtn">
                <li><h6 class="dropdown-header">By rating</h6></li>
                <li>
                    <a class="dropdown-item @(currentSort=="rating_asc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="rating_asc"
                       asp-route-searchString="@currentFilter">Rating ↑</a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort=="rating_desc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="rating_desc"
                       asp-route-searchString="@currentFilter">Rating ↓</a>
                </li>

                <li><h6 class="dropdown-header">By date</h6></li>
                <li>
                    <a class="dropdown-item @(currentSort=="date_asc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="date_asc"
                       asp-route-searchString="@currentFilter">Date ↑</a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort=="date_desc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="date_desc"
                       asp-route-searchString="@currentFilter">Date ↓</a>
                </li>

                <li><h6 class="dropdown-header">By item</h6></li>
                <li>
                    <a class="dropdown-item @(currentSort=="item_asc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="item_asc"
                       asp-route-searchString="@currentFilter">Item A→Z</a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort=="item_desc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="item_desc"
                       asp-route-searchString="@currentFilter">Item Z→A</a>
                </li>

                <li><h6 class="dropdown-header">By user</h6></li>
                <li>
                    <a class="dropdown-item @(currentSort=="user_asc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="user_asc"
                       asp-route-searchString="@currentFilter">User ↑</a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort=="user_desc"?"active":"")"
                       asp-action="Index"
                       asp-route-sortOrder="user_desc"
                       asp-route-searchString="@currentFilter">User ↓</a>
                </li>
            </ul>
        </div>
    </div>
</form>

<table class="table"  id="vue-modern" v-show="items.length">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model[0].Rating)</th>
            <th>@Html.DisplayNameFor(model => model[0].Comment)</th>
            <th>@Html.DisplayNameFor(model => model[0].ReviewDate)</th>
            <th>@Html.DisplayNameFor(model => model[0].Item)</th>
            <th>@Html.DisplayNameFor(model => model[0].User)</th>
            <th class="actions-header">Actions</th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        var canModify = User.IsInRole("Admin") || (currentUserId != null && item.UserId == currentUserId);
        <tr>
            <td>
                @{
                    var r = Math.Clamp(item.Rating, 0, 5);
                    var starsStr = new string('★', r) + new string('☆', 5 - r);
                }
                <span class="stars" aria-label="@item.Rating of 5">@starsStr</span>
            </td>
            <td>@Html.DisplayFor(modelItem => item.Comment)</td>
            <td>@Html.DisplayFor(modelItem => item.ReviewDate)</td>
            <td>@(item.Item != null ? item.Item.Name : item.ItemId.ToString())</td>
            <td>@(item.User != null ? $"{item.User.FirstName} {item.User.LastName}" : item.UserId)</td>
            <td class="actions-cell">
                <div class="actions">
                    @if (canModify)
                    {
                        <a asp-action="Edit" asp-route-id="@item.ReviewId" class="vue-btn edit">
                            <img class="button" src="~/images/edit.jpg" alt="Edit" />
                        </a>
                    }
                    <a asp-action="Details" asp-route-id="@item.ReviewId" class="vue-btn details">
                        <img class="button" src="~/images/Details.jpg" alt="Details" />
                    </a>
                    @if (canModify)
                    {
                        <a asp-action="Delete" asp-route-id="@item.ReviewId" class="vue-btn delete">
                            <img class="button" src="~/images/Delete.jpg" alt="Delete" />
                        </a>
                    }
                </div>
            </td>
        </tr>
}
    </tbody>
</table>

@{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
}
<a asp-action="Index"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex - 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   class="btn btn-default @prevDisabled">
    Previous
</a>
<a asp-action="Index"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex + 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   class="btn btn-default @nextDisabled">
    Next
</a>

@section Scripts {
    <script>
        (function () {
            const btn = document.getElementById('reviewsSortDropdownBtn');
            const menu = document.getElementById('reviewsSortDropdownMenu');

            if (!btn || !menu) return;

            function show() { menu.classList.add('show'); btn.setAttribute('aria-expanded', 'true'); }
            function hide() { menu.classList.remove('show'); btn.setAttribute('aria-expanded', 'false'); }

            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                menu.classList.contains('show') ? hide() : show();
            });

            document.addEventListener('click', function () { hide(); });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') hide();
            });

            menu.querySelectorAll('a.dropdown-item').forEach(a => {
                a.addEventListener('click', () => hide());
            });
        })();
    </script>
}
